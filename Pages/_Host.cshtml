@page "/"
@namespace DingDingApp.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é’‰é’‰ç®¡ç†ç³»ç»Ÿ</title>
    <base href="~/" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/material-base.css">
    <link href="css/site.css" rel="stylesheet" />
    <component type="typeof(Microsoft.AspNetCore.Components.Web.HeadOutlet)" render-mode="ServerPrerendered" />
</head>
<body>
    <component type="typeof(App)" render-mode="ServerPrerendered" />

    <div id="blazor-error-ui">
        <environment include="Staging,Production">
            å‘ç”Ÿé”™è¯¯ã€‚æ­¤åº”ç”¨ç¨‹åºåœ¨é‡æ–°åŠ è½½ä¹‹å‰å¯èƒ½ä¸å†å“åº”ã€‚
        </environment>
        <environment include="Development">
            å‘ç”Ÿäº†æœªå¤„ç†çš„å¼‚å¸¸ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ã€‚
        </environment>
        <a href="" class="reload">é‡æ–°åŠ è½½</a>
        <a class="dismiss">ğŸ—™</a>
    </div>
    
    <style>
        #blazor-error-ui {
            background: lightyellow;
            bottom: 0;
            box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.2);
            display: none;
            left: 0;
            padding: 0.6rem 1.25rem 0.7rem 1.25rem;
            position: fixed;
            width: 100%;
            z-index: 1000;
        }
        #blazor-error-ui .dismiss {
            cursor: pointer;
            position: absolute;
            right: 0.75rem;
            top: 0.5rem;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }
        .loading-text {
            margin-top: 1rem;
            font-size: 1.2rem;
            color: #666;
        }
        #app-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }
    </style>
    <div id="app-loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
        <div class="loading-text">æ­£åœ¨åŠ è½½åº”ç”¨...</div>
    </div>
    <script src="_framework/blazor.server.js"></script>
    <script src="_content/Radzen.Blazor/Radzen.Blazor.js"></script>
    <script src="js/site.js"></script>
    <script>
        // åŠ è½½é’‰é’‰ SDK
        window.loadDingTalkSDK = function() {
            return new Promise(function(resolve, reject) {
                // æ£€æŸ¥ SDK æ˜¯å¦å·²åŠ è½½
                if (typeof DDLogin !== 'undefined') {
                    console.log('é’‰é’‰ SDK å·²åŠ è½½');
                    resolve();
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨åŠ è½½ä¸­
                if (document.getElementById('dingtalk-login-sdk')) {
                    console.log('é’‰é’‰ SDK æ­£åœ¨åŠ è½½ä¸­...');
                    // ç­‰å¾…åŠ è½½å®Œæˆ
                    var checkInterval = setInterval(function() {
                        if (typeof DDLogin !== 'undefined') {
                            clearInterval(checkInterval);
                            console.log('é’‰é’‰ SDK åŠ è½½å®Œæˆ');
                            resolve();
                        }
                    }, 100);
                    
                    // è¶…æ—¶å¤„ç†ï¼ˆ5ç§’ï¼‰
                    setTimeout(function() {
                        clearInterval(checkInterval);
                        if (typeof DDLogin === 'undefined') {
                            reject(new Error('é’‰é’‰ SDK åŠ è½½è¶…æ—¶'));
                        }
                    }, 5000);
                    return;
                }
                
                // åˆ›å»º script æ ‡ç­¾
                var script = document.createElement('script');
                script.id = 'dingtalk-login-sdk';
                script.src = 'https://g.alicdn.com/dingding/dinglogin/0.0.5/ddLogin.js';
                script.async = true;
                
                script.onload = function() {
                    console.log('é’‰é’‰ç™»å½• SDK è„šæœ¬åŠ è½½æˆåŠŸ');
                    // ç­‰å¾…ä¸€ä¸‹ï¼Œç¡®ä¿ DDLogin å‡½æ•°å·²å®šä¹‰
                    setTimeout(function() {
                        if (typeof DDLogin !== 'undefined') {
                            resolve();
                        } else {
                            reject(new Error('é’‰é’‰ SDK åŠ è½½å®Œæˆï¼Œä½† DDLogin å‡½æ•°æœªå®šä¹‰'));
                        }
                    }, 100);
                };
                
                script.onerror = function() {
                    console.error('é’‰é’‰ç™»å½• SDK è„šæœ¬åŠ è½½å¤±è´¥');
                    reject(new Error('é’‰é’‰ SDK è„šæœ¬åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'));
                };
                
                document.head.appendChild(script);
            });
        };

        // åˆå§‹åŒ–é’‰é’‰ç™»å½•äºŒç»´ç 
        window.initDingTalkQRCode = function(qrCodeUrl, callbackUrl) {
            console.log('å¼€å§‹åˆå§‹åŒ–é’‰é’‰ç™»å½•äºŒç»´ç ');
            console.log('ç™»å½•URL: ', qrCodeUrl);
            console.log('å›è°ƒåœ°å€: ', callbackUrl);
            
            try {
                // æŸ¥æ‰¾ç™»å½•å®¹å™¨
                var container = document.getElementById('login_container');
                
                if (!container) {
                    console.error('æ‰¾ä¸åˆ°ç™»å½•å®¹å™¨å…ƒç´  (login_container)');
                    return;
                }
                
                // æ£€æŸ¥ DDLogin å‡½æ•°æ˜¯å¦å·²åŠ è½½
                if (typeof DDLogin === 'undefined') {
                    console.error('é’‰é’‰ç™»å½•SDKæœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    container.innerHTML = '<p style="color: #f00; padding: 20px;">äºŒç»´ç åŠ è½½å¤±è´¥ï¼šSDKæœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
                    return;
                }
                
                // æ¸…ç©ºå®¹å™¨å†…å®¹
                container.innerHTML = '';
                
                // ä½¿ç”¨é’‰é’‰å®˜æ–¹ SDK ç”ŸæˆäºŒç»´ç 
                // æ³¨æ„ï¼šæ ¹æ®é’‰é’‰æ–‡æ¡£ï¼Œgoto å‚æ•°åº”è¯¥æ˜¯å®Œæ•´çš„ç™»å½• URLï¼ˆåŒ…å« appidã€redirect_uri ç­‰ï¼‰
                // ä½†æ˜¯ï¼ŒDDLogin SDK ä¼šåœ¨è¿™ä¸ª URL åŸºç¡€ä¸Šæ„å»ºäºŒç»´ç ï¼Œæ‰«æåä¼šé€šè¿‡ postMessage å‘é€ä¸´æ—¶æˆæƒç 
                var gotoUrl = qrCodeUrl; // ä½¿ç”¨å®Œæ•´çš„ç™»å½• URL
                console.log('DDLogin goto å‚æ•°ï¼ˆå®Œæ•´ç™»å½•URLï¼‰:', gotoUrl);
                
                var obj = DDLogin({
                    id: 'login_container',
                    goto: encodeURIComponent(gotoUrl),
                    style: "border:none;background-color:#FFFFFF;",
                    width: "270",
                    height: "270"
                });
                
                console.log('é’‰é’‰å®˜æ–¹äºŒç»´ç å·²åŠ è½½ï¼ŒDDLogin å¯¹è±¡:', obj);
                console.log('DDLogin å¯¹è±¡ç±»å‹:', typeof obj);
                
                // ç›‘å¬æ¥è‡ªé’‰é’‰ç™»å½•é¡µé¢çš„æ¶ˆæ¯ï¼ˆå½“ç”¨æˆ·æ‰«æäºŒç»´ç åï¼‰
                // æ³¨æ„ï¼šæ¶ˆæ¯ç›‘å¬å¿…é¡»åœ¨å…¨å±€ä½œç”¨åŸŸï¼Œä¸èƒ½åªåœ¨å‡½æ•°å†…éƒ¨
                if (!window.dingTalkMessageHandlerAdded) {
                    console.log('æ·»åŠ é’‰é’‰ç™»å½•æ¶ˆæ¯ç›‘å¬å™¨...');
                    
                    // å…¨å±€æ¶ˆæ¯å¤„ç†å‡½æ•° - è®°å½•æ‰€æœ‰æ¶ˆæ¯ä»¥ä¾¿è°ƒè¯•
                    window.handleDingTalkLoginMessage = function (event) {
                        // è®°å½•æ‰€æœ‰æ¶ˆæ¯ï¼Œä¸ç®¡æ¥æº
                        console.log('=== æ”¶åˆ° window messageï¼ˆæ‰€æœ‰æ¶ˆæ¯ï¼‰ ===');
                        console.log('æ¶ˆæ¯æ¥æº (origin):', event.origin);
                        console.log('æ¶ˆæ¯æ•°æ® (data):', event.data);
                        console.log('æ¶ˆæ¯æ•°æ®ç±»å‹:', typeof event.data);
                        console.log('å®Œæ•´äº‹ä»¶:', event);
                        
                        // æ£€æŸ¥æ¶ˆæ¯æ¥æºï¼ˆé’‰é’‰ç™»å½•é¡µé¢çš„åŸŸåï¼‰
                        var origin = event.origin || '';
                        var isFromDingTalk = origin.includes("dingtalk.com") || 
                                           origin.includes("alicdn.com");
                        
                        // æ£€æŸ¥æ•°æ®æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æˆæƒç æ ¼å¼ï¼ˆé€šå¸¸æ˜¯å­—ç¬¦ä¸²ï¼Œé•¿åº¦åœ¨10-100ä¹‹é—´ï¼‰
                        var data = event.data;
                        var isValidCode = data && 
                                         typeof data === 'string' && 
                                         data.length > 10 && 
                                         data.length < 100 &&
                                         /^[a-zA-Z0-9]+$/.test(data); // åªåŒ…å«å­—æ¯å’Œæ•°å­—
                        
                        console.log('æ˜¯å¦æ¥è‡ªé’‰é’‰:', isFromDingTalk);
                        console.log('æ˜¯å¦æ˜¯æœ‰æ•ˆæˆæƒç æ ¼å¼:', isValidCode);
                        
                        // å¦‚æœæ¥è‡ªé’‰é’‰ï¼Œæˆ–è€…æ˜¯æœ‰æ•ˆæˆæƒç æ ¼å¼ï¼Œéƒ½å°è¯•å¤„ç†
                        if (isFromDingTalk || isValidCode) {
                            var loginTmpCode = data;
                            console.log('=== å¼€å§‹å¤„ç†ç™»å½•è¯·æ±‚ ===');
                            console.log('ä¸´æ—¶æˆæƒç :', loginTmpCode);
                            
                            // æ˜¾ç¤ºå¤„ç†ä¸­çš„æç¤º
                            var container = document.getElementById('login_container');
                            if (container) {
                                container.innerHTML = '<div style="padding: 20px; text-align: center;"><p style="color: #007bff; font-size: 16px;">æ­£åœ¨ç™»å½•...</p><p style="color: #666; margin-top: 10px; font-size: 12px;">è¯·ç¨å€™</p></div>';
                            }
                            
                            // è°ƒç”¨åç«¯APIè¿›è¡Œç™»å½•
                            fetch('/api/auth/login-by-code', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                credentials: 'include', // é‡è¦ï¼šåŒ…å« cookies
                                body: JSON.stringify({ code: loginTmpCode })
                            })
                            .then(function(response) {
                                console.log('ç™»å½•APIå“åº”çŠ¶æ€:', response.status, response.statusText);
                                if (!response.ok) {
                                    return response.text().then(function(text) {
                                        console.error('HTTPé”™è¯¯å“åº”å†…å®¹:', text);
                                        throw new Error('HTTPé”™è¯¯: ' + response.status + ', å“åº”: ' + text);
                                    });
                                }
                                return response.json();
                            })
                            .then(function(data) {
                                console.log('ç™»å½•APIå“åº”æ•°æ®:', JSON.stringify(data));
                                if (data && data.success) {
                                    console.log('ç™»å½•æˆåŠŸï¼Œå‡†å¤‡è·³è½¬...');
                                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                                    var container = document.getElementById('login_container');
                                    if (container) {
                                        container.innerHTML = '<div style="padding: 20px; text-align: center;"><p style="color: #28a745; font-size: 16px;">âœ“ ç™»å½•æˆåŠŸï¼</p><p style="color: #666; margin-top: 10px;">æ­£åœ¨è·³è½¬...</p></div>';
                                    }
                                    // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
                                    setTimeout(function() {
                                        window.location.href = '/users';
                                    }, 1000);
                                } else {
                                    console.error('ç™»å½•å¤±è´¥:', data.message || data.msg || 'æœªçŸ¥é”™è¯¯');
                                    var container = document.getElementById('login_container');
                                    if (container) {
                                        container.innerHTML = '<div style="padding: 20px; text-align: center;"><p style="color: #dc3545;">ç™»å½•å¤±è´¥: ' + (data.message || data.msg || 'æœªçŸ¥é”™è¯¯') + '</p><p style="color: #666; margin-top: 10px; font-size: 12px;">è¯·åˆ·æ–°é¡µé¢é‡è¯•</p></div>';
                                    }
                                }
                            })
                            .catch(function(error) {
                                console.error('ç™»å½•APIè°ƒç”¨å¤±è´¥:', error);
                                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                                var container = document.getElementById('login_container');
                                if (container) {
                                    container.innerHTML = '<div style="padding: 20px; text-align: center;"><p style="color: #dc3545;">ç™»å½•å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯') + '</p><p style="color: #666; margin-top: 10px; font-size: 12px;">è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯</p></div>';
                                }
                            });
                        } else {
                            console.log('æ¶ˆæ¯ä¸ç¬¦åˆæ¡ä»¶ï¼Œå¿½ç•¥ã€‚æ¥æº:', origin, 'æ•°æ®:', data, 'ç±»å‹:', typeof data);
                        }
                    };
                    
                    // æ·»åŠ ä¸€ä¸ªå…¨å±€çš„æ¶ˆæ¯ç›‘å¬å™¨ï¼Œè®°å½•æ‰€æœ‰æ¶ˆæ¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰
                    window.allMessagesListener = function(event) {
                        console.log('ã€å…¨å±€æ¶ˆæ¯ç›‘å¬ã€‘æ¥æº:', event.origin, 'æ•°æ®:', event.data, 'ç±»å‹:', typeof event.data);
                    };
                    
                    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ - ä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿èƒ½æ•è·æ‰€æœ‰æ¶ˆæ¯
                    if (typeof window.addEventListener !== 'undefined') {
                        // æ·»åŠ å¤šä¸ªç›‘å¬å™¨ï¼Œç¡®ä¿èƒ½æ•è·æ¶ˆæ¯
                        window.addEventListener('message', window.handleDingTalkLoginMessage, false);
                        window.addEventListener('message', window.allMessagesListener, true); // ä½¿ç”¨æ•è·é˜¶æ®µ
                        console.log('å·²æ·»åŠ  window.addEventListener æ¶ˆæ¯ç›‘å¬å™¨ï¼ˆæ™®é€šå’Œæ•è·é˜¶æ®µï¼‰');
                    } else if (typeof window.attachEvent !== 'undefined') {
                        window.attachEvent('onmessage', window.handleDingTalkLoginMessage);
                        console.log('å·²æ·»åŠ  window.attachEvent æ¶ˆæ¯ç›‘å¬å™¨');
                    } else {
                        console.error('æ— æ³•æ·»åŠ æ¶ˆæ¯ç›‘å¬å™¨ï¼šæµè§ˆå™¨ä¸æ”¯æŒ');
                    }
                    
                    // ä¹Ÿå°è¯•ç›‘å¬ DDLogin å¯¹è±¡çš„äº‹ä»¶ï¼ˆå¦‚æœæ”¯æŒï¼‰
                    if (obj && typeof obj === 'object') {
                        try {
                            var objKeys = Object.keys(obj);
                            console.log('DDLogin å¯¹è±¡å±æ€§:', objKeys);
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰å›è°ƒå‡½æ•°å±æ€§
                            for (var key in obj) {
                                if (typeof obj[key] === 'function') {
                                    console.log('DDLogin å¯¹è±¡æ–¹æ³•:', key);
                                }
                            }
                            
                            // æœ‰äº›ç‰ˆæœ¬çš„ DDLogin SDK å¯èƒ½æä¾›äº‹ä»¶å›è°ƒ
                            if (typeof obj.onSuccess === 'function') {
                                console.log('å‘ç° DDLogin.onSuccess å›è°ƒ');
                                var originalOnSuccess = obj.onSuccess;
                                obj.onSuccess = function(code) {
                                    console.log('DDLogin.onSuccess å›è°ƒè¢«è§¦å‘ï¼Œcode:', code);
                                    if (originalOnSuccess) {
                                        originalOnSuccess.call(obj, code);
                                    }
                                    window.handleDingTalkLoginMessage({
                                        origin: 'https://login.dingtalk.com',
                                        data: code
                                    });
                                };
                            }
                        } catch (e) {
                            console.warn('æ— æ³•è®¿é—® DDLogin å¯¹è±¡å±æ€§:', e);
                        }
                    }
                    
                    // æ·»åŠ æµ‹è¯•å‡½æ•°
                    window.testDingTalkMessage = function() {
                        console.log('æµ‹è¯•ï¼šæ¨¡æ‹Ÿæ”¶åˆ°é’‰é’‰ç™»å½•æ¶ˆæ¯');
                        window.handleDingTalkLoginMessage({
                            origin: 'https://login.dingtalk.com',
                            data: 'test_code_12345678901234567890'
                        });
                    };
                    
                    window.dingTalkMessageHandlerAdded = true;
                    console.log('é’‰é’‰ç™»å½•æ¶ˆæ¯ç›‘å¬å™¨å·²æ·»åŠ ï¼Œç­‰å¾…æ‰«ç ...');
                    console.log('è°ƒè¯•æç¤ºï¼š');
                    console.log('1. æ‰«æäºŒç»´ç åï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰ "æ”¶åˆ° window message" æ—¥å¿—');
                    console.log('2. å¦‚æœæ²¡æœ‰æ—¥å¿—ï¼Œå¯èƒ½æ¶ˆæ¯æ²¡æœ‰å‘é€ï¼Œæˆ–è€…ä½¿ç”¨äº†å›è°ƒ URL');
                    console.log('3. å¯ä»¥è¾“å…¥ window.testDingTalkMessage() æµ‹è¯•æ¶ˆæ¯ç›‘å¬æ˜¯å¦å·¥ä½œ');
                } else {
                    console.log('æ¶ˆæ¯ç›‘å¬å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ');
                }
            } catch (e) {
                console.error('åˆå§‹åŒ–é’‰é’‰ç™»å½•äºŒç»´ç å¤±è´¥:', e);
                var container = document.getElementById('login_container');
                if (container) {
                    container.innerHTML = '<p style="color: #f00; padding: 20px;">äºŒç»´ç åŠ è½½å¤±è´¥: ' + e.message + '</p>';
                }
            }
        };

        // ç›‘å¬ Blazor é”™è¯¯
        window.addEventListener('error', (event) => {
            console.error('é¡µé¢é”™è¯¯:', event.error, event.message, event.filename, event.lineno);
            const loadingDiv = document.getElementById('app-loading');
            if (loadingDiv) {
                loadingDiv.innerHTML = '<div style="color: red; padding: 20px;">åŠ è½½å¤±è´¥: ' + (event.message || 'æœªçŸ¥é”™è¯¯') + '<br/>è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯</div>';
            }
        });
        
        // ç›‘å¬æœªå¤„ç†çš„ Promise æ‹’ç»
        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå¤„ç†çš„ Promise æ‹’ç»:', event.reason);
        });
        
        // ç›‘å¬é¡µé¢åŠ è½½
        window.addEventListener('load', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            // å»¶è¿Ÿéšè—åŠ è½½æç¤ºï¼Œç­‰å¾… Blazor è¿æ¥å»ºç«‹
            setTimeout(() => {
                const loadingDiv = document.getElementById('app-loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
            }, 1500);
        });
        
        // ç›‘å¬ Blazor è¿æ¥çŠ¶æ€
        if (window.Blazor) {
            console.log('Blazor å¯¹è±¡å·²åŠ è½½');
            
            // ç›‘å¬ Blazor è¿æ¥é”™è¯¯ï¼ˆä»…åœ¨å¯¹è±¡å­˜åœ¨æ—¶ï¼‰
            if (Blazor.defaultReconnectionHandler) {
                try {
                    Blazor.defaultReconnectionHandler._reconnectDisplay = {
                        show: () => console.log('Blazor æ­£åœ¨é‡æ–°è¿æ¥...'),
                        update: (d) => console.log('Blazor é‡è¿è¿›åº¦:', d),
                        rejected: () => console.error('Blazor é‡è¿è¢«æ‹’ç»')
                    };
                } catch (e) {
                    console.warn('æ— æ³•è®¾ç½® Blazor é‡è¿æ˜¾ç¤º:', e);
                }
            }
        }
        
        // ç›‘å¬ DOM å˜åŒ–ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                        const errorUI = node.querySelector ? node.querySelector('#blazor-error-ui') : null;
                        if (errorUI && errorUI.style.display !== 'none') {
                            console.error('Blazor é”™è¯¯ UI å·²æ˜¾ç¤º');
                            const errorText = errorUI.textContent || errorUI.innerText;
                            console.error('é”™è¯¯å†…å®¹:', errorText);
                        }
                    }
                });
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
</body>
</html>

