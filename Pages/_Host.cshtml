@page "/"
@namespace DingDingApp.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é’‰é’‰ç®¡ç†ç³»ç»Ÿ</title>
    <base href="~/" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/material-base.css">
    <link href="css/site.css" rel="stylesheet" />
    <component type="typeof(Microsoft.AspNetCore.Components.Web.HeadOutlet)" render-mode="ServerPrerendered" />
</head>
<body>
    <component type="typeof(App)" render-mode="ServerPrerendered" />

    <div id="blazor-error-ui">
        <environment include="Staging,Production">
            å‘ç”Ÿé”™è¯¯ã€‚æ­¤åº”ç”¨ç¨‹åºåœ¨é‡æ–°åŠ è½½ä¹‹å‰å¯èƒ½ä¸å†å“åº”ã€‚
        </environment>
        <environment include="Development">
            å‘ç”Ÿäº†æœªå¤„ç†çš„å¼‚å¸¸ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ã€‚
        </environment>
        <a href="" class="reload">é‡æ–°åŠ è½½</a>
        <a class="dismiss">ğŸ—™</a>
    </div>
    
    <style>
        #blazor-error-ui {
            background: lightyellow;
            bottom: 0;
            box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.2);
            display: none;
            left: 0;
            padding: 0.6rem 1.25rem 0.7rem 1.25rem;
            position: fixed;
            width: 100%;
            z-index: 1000;
        }
        #blazor-error-ui .dismiss {
            cursor: pointer;
            position: absolute;
            right: 0.75rem;
            top: 0.5rem;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }
        .loading-text {
            margin-top: 1rem;
            font-size: 1.2rem;
            color: #666;
        }
        #app-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }
    </style>
    <div id="app-loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
        <div class="loading-text">æ­£åœ¨åŠ è½½åº”ç”¨...</div>
    </div>
    <script src="_framework/blazor.server.js"></script>
    <script src="_content/Radzen.Blazor/Radzen.Blazor.js"></script>
    <script src="js/site.js"></script>
    <script>
        // ç›‘å¬ Blazor é”™è¯¯
        window.addEventListener('error', (event) => {
            console.error('é¡µé¢é”™è¯¯:', event.error, event.message, event.filename, event.lineno);
            const loadingDiv = document.getElementById('app-loading');
            if (loadingDiv) {
                loadingDiv.innerHTML = '<div style="color: red; padding: 20px;">åŠ è½½å¤±è´¥: ' + (event.message || 'æœªçŸ¥é”™è¯¯') + '<br/>è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯</div>';
            }
        });
        
        // ç›‘å¬æœªå¤„ç†çš„ Promise æ‹’ç»
        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå¤„ç†çš„ Promise æ‹’ç»:', event.reason);
        });
        
        // ç›‘å¬é¡µé¢åŠ è½½
        window.addEventListener('load', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            // å»¶è¿Ÿéšè—åŠ è½½æç¤ºï¼Œç­‰å¾… Blazor è¿æ¥å»ºç«‹
            setTimeout(() => {
                const loadingDiv = document.getElementById('app-loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
            }, 1500);
        });
        
        // ç›‘å¬ Blazor è¿æ¥çŠ¶æ€
        if (window.Blazor) {
            console.log('Blazor å¯¹è±¡å·²åŠ è½½');
            
            // ç›‘å¬ Blazor è¿æ¥é”™è¯¯ï¼ˆä»…åœ¨å¯¹è±¡å­˜åœ¨æ—¶ï¼‰
            if (Blazor.defaultReconnectionHandler) {
                try {
                    Blazor.defaultReconnectionHandler._reconnectDisplay = {
                        show: () => console.log('Blazor æ­£åœ¨é‡æ–°è¿æ¥...'),
                        update: (d) => console.log('Blazor é‡è¿è¿›åº¦:', d),
                        rejected: () => console.error('Blazor é‡è¿è¢«æ‹’ç»')
                    };
                } catch (e) {
                    console.warn('æ— æ³•è®¾ç½® Blazor é‡è¿æ˜¾ç¤º:', e);
                }
            }
        }
        
        // ç›‘å¬ DOM å˜åŒ–ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                        const errorUI = node.querySelector ? node.querySelector('#blazor-error-ui') : null;
                        if (errorUI && errorUI.style.display !== 'none') {
                            console.error('Blazor é”™è¯¯ UI å·²æ˜¾ç¤º');
                            const errorText = errorUI.textContent || errorUI.innerText;
                            console.error('é”™è¯¯å†…å®¹:', errorText);
                        }
                    }
                });
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
</body>
</html>

