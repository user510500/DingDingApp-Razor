@page "/"
@inject ApiService ApiService
@inject NavigationManager NavigationManager
@inject ILogger<Index> Logger
@inject IJSRuntime JSRuntime

<PageTitle>ç™»å½•</PageTitle>

<!-- ç®€åŒ–ç‰ˆæœ¬ï¼Œå…ˆä¸ä½¿ç”¨ Radzen ç»„ä»¶ -->
<div style="padding: 20px; max-width: 800px; margin: 0 auto;">
    <h1>é’‰é’‰æ‰«ç ç™»å½•</h1>
    <p>è¯·ä½¿ç”¨é’‰é’‰APPæ‰«æä¸‹æ–¹äºŒç»´ç è¿›è¡Œç™»å½•</p>

    <!-- å¼€å‘æ¨¡å¼ï¼šè·³è¿‡ç™»å½• -->
    @* <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 4px;">
        <h3 style="margin-top: 0; color: #856404;">ğŸ”§ å¼€å‘æ¨¡å¼</h3>
        <p style="margin-bottom: 10px; color: #856404;">è·³è¿‡ç™»å½•ï¼Œç›´æ¥è¿›å…¥åå°è¿›è¡ŒåŠŸèƒ½æµ‹è¯•</p>
        <button @onclick="SkipLogin" 
                disabled="@isLoading"
                style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">
            âš¡ è·³è¿‡ç™»å½•ï¼Œç›´æ¥è¿›å…¥åå°
        </button>
    </div> *@

    <!-- è°ƒè¯•ä¿¡æ¯ -->
    @* <div style="background: #f0f0f0; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px;">
        <strong>è°ƒè¯•ä¿¡æ¯ï¼š</strong><br/>
        é¡µé¢å·²åŠ è½½ | isLoading: @isLoading | isInitialized: @isInitialized<br/>
        qrCodeUrl: @(string.IsNullOrEmpty(qrCodeUrl) ? "ç©º" : $"æœ‰å€¼ ({qrCodeUrl.Substring(0, Math.Min(50, qrCodeUrl.Length))}...)")<br/>
        errorMessage: @(string.IsNullOrEmpty(errorMessage) ? "ç©º" : errorMessage)<br/>
        queryError: @(string.IsNullOrEmpty(queryError) ? "ç©º" : queryError)<br/>
        qrCodeGenerated: @qrCodeGenerated
    </div> *@

    @if (!string.IsNullOrEmpty(queryError))
    {
        <div style="background: #f8d7da; color: #721c24; padding: 15px; margin: 10px 0; border: 1px solid #f5c6cb; border-radius: 4px;">
            <strong>ç™»å½•å¤±è´¥ï¼š</strong> @queryError
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div style="background: #fff3cd; color: #856404; padding: 15px; margin: 10px 0; border: 1px solid #ffeaa7; border-radius: 4px;">
            <strong>é”™è¯¯ï¼š</strong> @errorMessage
            <br/><br/>
            <button @onclick="LoadQrCode" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">é‡è¯•</button>
        </div>
    }
    else if (!string.IsNullOrEmpty(qrCodeUrl))
    {
        <div style="text-align: center; margin: 20px 0;">
            <h3>è¯·ä½¿ç”¨é’‰é’‰APPæ‰«æä¸‹æ–¹äºŒç»´ç ç™»å½•</h3>
            <div style="margin: 20px 0;">
                <!-- ä½¿ç”¨é’‰é’‰å®˜æ–¹ SDK ç›´æ¥æ˜¾ç¤ºå®˜æ–¹äºŒç»´ç  -->
                <div id="login_container" style="margin: 20px auto; width: 300px; height: 300px; border: 2px solid #ddd; border-radius: 8px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: white; display: flex; align-items: center; justify-content: center;">
                    <p style="color: #999;">æ­£åœ¨åŠ è½½äºŒç»´ç ...</p>
                </div>
                <p style="color: #666; margin-top: 15px; font-size: 14px;">
                    <strong>ä½¿ç”¨é’‰é’‰APPæ‰«æä¸Šæ–¹äºŒç»´ç å³å¯å®Œæˆç™»å½•</strong><br/>
                    <span style="font-size: 12px; color: #999;">æç¤ºï¼šè¯·ä½¿ç”¨é’‰é’‰APPçš„æ‰«ä¸€æ‰«åŠŸèƒ½ï¼Œä¸è¦ä½¿ç”¨å…¶ä»–æ‰«ç å·¥å…·</span>
                </p>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #007bff;">
                <p style="margin: 0; font-size: 14px; color: #495057;">
                    <strong>æç¤ºï¼š</strong> è¿™æ˜¯é’‰é’‰å®˜æ–¹äºŒç»´ç ï¼Œç›´æ¥æ˜¾ç¤ºåœ¨æœ¬é¡µé¢ã€‚æ‰«æåä¼šåœ¨é’‰é’‰APPä¸­å®Œæˆç™»å½•ï¼Œä¸ä¼šè·³è½¬åˆ°æµè§ˆå™¨é¡µé¢ã€‚
                </p>
            </div>
        </div>
    }
    else if (isLoading)
    {
        <div style="text-align: center; margin: 20px 0;">
            <p>æ­£åœ¨åŠ è½½äºŒç»´ç ...</p>
            <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;"></div>
        </div>
    }
    else
    {
        <div style="background: #d1ecf1; color: #0c5460; padding: 15px; margin: 10px 0; border: 1px solid #bee5eb; border-radius: 4px;">
            <strong>æç¤ºï¼š</strong> é¡µé¢å·²åŠ è½½ï¼Œä½†æœªè·å–åˆ°äºŒç»´ç ã€‚è¯·ç‚¹å‡»é‡è¯•æŒ‰é’®ã€‚
            <br/><br/>
            <button @onclick="LoadQrCode" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">é‡è¯•</button>
        </div>
    }
</div>

<style>
    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script>
    // å¼€å‘æ¨¡å¼ç™»å½•å‡½æ•° - é€šè¿‡ JavaScript è°ƒç”¨ APIï¼Œç¡®ä¿åœ¨æ–°çš„ HTTP è¯·æ±‚ä¸­æ‰§è¡Œ
    window.devLogin = async function(baseUrl) {
        try {
            console.log('å¼€å§‹å¼€å‘æ¨¡å¼ç™»å½•...');
            const response = await fetch(baseUrl + 'api/auth/dev-login', {
                method: 'POST',
                credentials: 'include', // é‡è¦ï¼šåŒ…å« cookies
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('å¼€å‘æ¨¡å¼ç™»å½•å“åº”çŠ¶æ€:', response.status);
            
            if (response.ok) {
                const result = await response.json();
                console.log('å¼€å‘æ¨¡å¼ç™»å½•æˆåŠŸ:', result);
                return true;
            } else {
                const errorText = await response.text();
                console.error('å¼€å‘æ¨¡å¼ç™»å½•å¤±è´¥:', response.status, errorText);
                return false;
            }
        } catch (error) {
            console.error('å¼€å‘æ¨¡å¼ç™»å½•å¼‚å¸¸:', error);
            return false;
        }
    };
</script>

@code {
    [Parameter, SupplyParameterFromQuery] public string? error { get; set; }

    private string qrCodeUrl = string.Empty;
    private string errorMessage = string.Empty;
    private string queryError = string.Empty;
    private bool isLoading = true;
    private bool isInitialized = false;
    private bool qrCodeGenerated = false; // è·Ÿè¸ªäºŒç»´ç æ˜¯å¦å·²ç”Ÿæˆ
    private bool dingTalkLoginInitialized = false; // è·Ÿè¸ªé’‰é’‰ç™»å½•æ˜¯å¦å·²åˆå§‹åŒ–

    private string GetQrCodeImageUrl()
    {
        if (string.IsNullOrEmpty(qrCodeUrl))
        {
            return string.Empty;
        }
        return $"https://api.qrserver.com/v1/create-qr-code/?size=256x256&data={Uri.EscapeDataString(qrCodeUrl)}";
    }

    protected override void OnInitialized()
    {
        queryError = error ?? string.Empty;
        isLoading = false; // å…ˆè®¾ç½®ä¸º falseï¼Œè®©é¡µé¢ç«‹å³æ˜¾ç¤º
        isInitialized = true;
        Logger.LogInformation("Index.razor OnInitialized. queryError={QueryError}", queryError);
        
        // å¦‚æœ URL ä¸­åŒ…å« error å‚æ•°ï¼Œè¯´æ˜å›è°ƒæ—¶å‡ºé”™äº†
        if (!string.IsNullOrEmpty(queryError))
        {
            Logger.LogWarning("æ£€æµ‹åˆ°ç™»å½•é”™è¯¯: {Error}", queryError);
        }
        
        // å…ˆæ˜¾ç¤ºé¡µé¢å†…å®¹ï¼Œç„¶åå¼‚æ­¥åŠ è½½æ•°æ®
        _ = LoadDataAsync();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // å¦‚æœå·²æ˜¾ç¤ºäºŒç»´ç ä¸”æœªåˆå§‹åŒ–ï¼Œåˆå§‹åŒ–é’‰é’‰ç™»å½• SDK
        if (!string.IsNullOrEmpty(qrCodeUrl) && string.IsNullOrEmpty(queryError) && !dingTalkLoginInitialized)
        {
            // ç­‰å¾…ä¸€ä¸‹ï¼Œç¡®ä¿ DOM å·²æ¸²æŸ“
            await Task.Delay(100);
            await InitializeDingTalkLogin();
            
            // å¦‚æœæ˜¯é¦–æ¬¡æ¸²æŸ“ï¼Œå¼€å§‹è½®è¯¢æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (firstRender)
            {
                _ = StartLoginStatusPolling();
            }
        }
    }
    
    private async Task StartLoginStatusPolling()
    {
        // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ç™»å½•çŠ¶æ€ï¼Œæœ€å¤šæ£€æŸ¥300æ¬¡ï¼ˆ10åˆ†é’Ÿï¼‰
        int maxAttempts = 300;
        int attempts = 0;
        
        Logger.LogInformation("å¼€å§‹è½®è¯¢ç™»å½•çŠ¶æ€");
        
        while (!string.IsNullOrEmpty(qrCodeUrl) && string.IsNullOrEmpty(queryError) && !isLoading && attempts < maxAttempts)
        {
            await Task.Delay(2000);
            attempts++;
            
            try
            {
                var statusResponse = await ApiService.GetLoginStatusAsync();
                if (statusResponse?.Success == true && statusResponse.Data?.IsLoggedIn == true)
                {
                    Logger.LogInformation("æ£€æµ‹åˆ°ç”¨æˆ·å·²ç™»å½•ï¼Œè·³è½¬åˆ° /users");
                    NavigationManager.NavigateTo("/users", true);
                    break;
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥");
                // ç»§ç»­è½®è¯¢ï¼Œä¸ä¸­æ–­
            }
        }
        
        if (attempts >= maxAttempts)
        {
            Logger.LogInformation("ç™»å½•çŠ¶æ€è½®è¯¢è¶…æ—¶ï¼Œåœæ­¢æ£€æŸ¥");
        }
    }
    
    private async Task LoadDataAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            Logger.LogInformation("Index.razor LoadDataAsync start");
        
        // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œè®©é¡µé¢å…ˆæ¸²æŸ“
            await Task.Delay(200);

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            var statusResponse = await ApiService.GetLoginStatusAsync();
            if (statusResponse?.Success == true && statusResponse.Data?.IsLoggedIn == true)
            {
                Logger.LogInformation("ç”¨æˆ·å·²ç™»å½•ï¼Œè·³è½¬ /users");
                NavigationManager.NavigateTo("/users", true);
                return;
            }

            // åŠ è½½äºŒç»´ç 
            await LoadQrCode();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Index åˆå§‹åŒ–å¤±è´¥");
            errorMessage = $"åˆå§‹åŒ–å¤±è´¥: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            Logger.LogInformation("Index.razor LoadDataAsync complete. isLoading={IsLoading}, qrCodeUrlç©º: {EmptyQr}", isLoading, string.IsNullOrEmpty(qrCodeUrl));
            StateHasChanged();
        }
    }

    private async Task LoadQrCode()
    {
        try
        {
            qrCodeGenerated = false; // é‡ç½®äºŒç»´ç ç”Ÿæˆæ ‡å¿—
            dingTalkLoginInitialized = false; // é‡ç½®é’‰é’‰ç™»å½•åˆå§‹åŒ–æ ‡å¿—
            var response = await ApiService.GetQrCodeAsync();
            if (response?.Success == true && response.Data != null)
            {
                qrCodeUrl = response.Data.QrCodeUrl ?? string.Empty;
                Logger.LogInformation("è·å–äºŒç»´ç æˆåŠŸ: {Url}", qrCodeUrl);
                
                // æ›´æ–° UI
                StateHasChanged();
                
                // å¦‚æœæˆåŠŸåŠ è½½äºŒç»´ç ï¼Œå¼€å§‹è½®è¯¢ç™»å½•çŠ¶æ€
                if (!string.IsNullOrEmpty(qrCodeUrl) && string.IsNullOrEmpty(errorMessage))
                {
                    _ = StartLoginStatusPolling();
                }
            }
            else
            {
                errorMessage = response?.Message ?? "è·å–äºŒç»´ç å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ";
                Logger.LogWarning("è·å–äºŒç»´ç æ¥å£å¤±è´¥: {Message}", errorMessage);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"è·å–äºŒç»´ç å¤±è´¥: {ex.Message}ã€‚è¯·æ£€æŸ¥ï¼š1) åç«¯ API æ˜¯å¦æ­£å¸¸è¿è¡Œ 2) ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ 3) æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯";
            Logger.LogError(ex, "è·å–äºŒç»´ç å¼‚å¸¸");
        }
        finally
        {
            isLoading = false;
            isInitialized = true;
            Logger.LogInformation("LoadQrCode å®Œæˆ. isLoading={IsLoading}, errorMessageç©º: {EmptyError}", isLoading, string.IsNullOrEmpty(errorMessage));
            StateHasChanged();
        }
    }

    private async Task SkipLogin()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            Logger.LogInformation("å¼€å§‹å¼€å‘æ¨¡å¼ç™»å½• - ä½¿ç”¨ JavaScript è°ƒç”¨ API");
            
            // ä½¿ç”¨ JavaScript è°ƒç”¨ APIï¼Œè¿™æ ·å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ HTTP è¯·æ±‚
            // æ­¤æ—¶ Session æ˜¯å®Œå…¨å¯ç”¨çš„
            var success = await JSRuntime.InvokeAsync<bool>("devLogin", NavigationManager.BaseUri);
            
            if (success)
            {
                Logger.LogInformation("å¼€å‘æ¨¡å¼ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ° /users");
                // ä½¿ç”¨ forceLoad ç¡®ä¿é‡æ–°åŠ è½½é¡µé¢ä»¥è·å–æ–°çš„ Session
                NavigationManager.NavigateTo("/users", forceLoad: true);
            }
            else
            {
                errorMessage = "å¼€å‘æ¨¡å¼ç™»å½•å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯";
                Logger.LogWarning("å¼€å‘æ¨¡å¼ç™»å½•å¤±è´¥");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"å¼€å‘æ¨¡å¼ç™»å½•å¤±è´¥: {ex.Message}";
            Logger.LogError(ex, "å¼€å‘æ¨¡å¼ç™»å½•å¼‚å¸¸");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task InitializeDingTalkLogin()
    {
        // é˜²æ­¢é‡å¤åˆå§‹åŒ–
        if (dingTalkLoginInitialized)
        {
            return;
        }

        try
        {
            if (string.IsNullOrEmpty(qrCodeUrl))
            {
                Logger.LogWarning("qrCodeUrl ä¸ºç©ºï¼Œæ— æ³•åˆå§‹åŒ–é’‰é’‰ç™»å½•");
                return;
            }

            Logger.LogInformation("å¼€å§‹åˆå§‹åŒ–é’‰é’‰ç™»å½•ï¼ŒURL: {Url}", qrCodeUrl);

            // é¦–å…ˆç¡®ä¿é’‰é’‰ SDK å·²åŠ è½½
            try
            {
                // loadDingTalkSDK è¿”å› Promiseï¼Œä½¿ç”¨ InvokeAsync ç­‰å¾…å®Œæˆ
                await JSRuntime.InvokeAsync<object>("loadDingTalkSDK");
                Logger.LogInformation("é’‰é’‰ SDK åŠ è½½æˆåŠŸ");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "åŠ è½½é’‰é’‰ SDK å¤±è´¥: {Error}", ex.Message);
                errorMessage = $"åŠ è½½é’‰é’‰ SDK å¤±è´¥: {ex.Message}";
                StateHasChanged();
                return;
            }
            
            // ç­‰å¾…ä¸€ä¸‹ï¼Œç¡®ä¿ SDK å®Œå…¨åŠ è½½
            await Task.Delay(300);
            
            // è·å–å›è°ƒåœ°å€ï¼ˆç”¨äº DDLogin SDK çš„ goto å‚æ•°ï¼‰
            var baseUrl = NavigationManager.BaseUri.TrimEnd('/');
            var callbackUrl = $"{baseUrl}/api/auth/callback";
            
            // åˆå§‹åŒ–é’‰é’‰ç™»å½•äºŒç»´ç 
            // æ³¨æ„ï¼šDDLogin SDK çš„ goto å‚æ•°åº”è¯¥æ˜¯å›è°ƒåœ°å€ï¼Œè€Œä¸æ˜¯å®Œæ•´çš„ç™»å½• URL
            await JSRuntime.InvokeVoidAsync("initDingTalkQRCode", qrCodeUrl, callbackUrl);
            
            // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
            dingTalkLoginInitialized = true;
            
            Logger.LogInformation("é’‰é’‰ç™»å½•åˆå§‹åŒ–å®Œæˆï¼Œå›è°ƒåœ°å€: {CallbackUrl}", callbackUrl);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "åˆå§‹åŒ–é’‰é’‰ç™»å½•å¤±è´¥: {Error}", ex.Message);
            errorMessage = $"åˆå§‹åŒ–é’‰é’‰ç™»å½•å¤±è´¥: {ex.Message}ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚";
            StateHasChanged();
        }
    }
}
