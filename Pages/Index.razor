@page "/"
@inject ApiService ApiService
@inject NavigationManager NavigationManager
@inject ILogger<Index> Logger
@inject IJSRuntime JSRuntime

<PageTitle>ç™»å½•</PageTitle>

<!-- ç®€åŒ–ç‰ˆæœ¬ï¼Œå…ˆä¸ä½¿ç”¨ Radzen ç»„ä»¶ -->
<div style="padding: 20px; max-width: 800px; margin: 0 auto;">
    <h1>é’‰é’‰æ‰«ç ç™»å½•</h1>
    <p>è¯·ä½¿ç”¨é’‰é’‰APPæ‰«æä¸‹æ–¹äºŒç»´ç è¿›è¡Œç™»å½•</p>

    <!-- å¼€å‘æ¨¡å¼ï¼šè·³è¿‡ç™»å½• -->
    <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 4px;">
        <h3 style="margin-top: 0; color: #856404;">ğŸ”§ å¼€å‘æ¨¡å¼</h3>
        <p style="margin-bottom: 10px; color: #856404;">è·³è¿‡ç™»å½•ï¼Œç›´æ¥è¿›å…¥åå°è¿›è¡ŒåŠŸèƒ½æµ‹è¯•</p>
        <button @onclick="SkipLogin" 
                disabled="@isLoading"
                style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">
            âš¡ è·³è¿‡ç™»å½•ï¼Œç›´æ¥è¿›å…¥åå°
        </button>
    </div>

    <!-- è°ƒè¯•ä¿¡æ¯ -->
    <div style="background: #f0f0f0; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px;">
        <strong>è°ƒè¯•ä¿¡æ¯ï¼š</strong><br/>
        é¡µé¢å·²åŠ è½½ | isLoading: @isLoading | isInitialized: @isInitialized<br/>
        qrCodeUrl: @(string.IsNullOrEmpty(qrCodeUrl) ? "ç©º" : $"æœ‰å€¼ ({qrCodeUrl.Substring(0, Math.Min(50, qrCodeUrl.Length))}...)")<br/>
        errorMessage: @(string.IsNullOrEmpty(errorMessage) ? "ç©º" : errorMessage)<br/>
        queryError: @(string.IsNullOrEmpty(queryError) ? "ç©º" : queryError)<br/>
        qrCodeGenerated: @qrCodeGenerated
    </div>

    @if (!string.IsNullOrEmpty(queryError))
    {
        <div style="background: #f8d7da; color: #721c24; padding: 15px; margin: 10px 0; border: 1px solid #f5c6cb; border-radius: 4px;">
            <strong>ç™»å½•å¤±è´¥ï¼š</strong> @queryError
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div style="background: #fff3cd; color: #856404; padding: 15px; margin: 10px 0; border: 1px solid #ffeaa7; border-radius: 4px;">
            <strong>é”™è¯¯ï¼š</strong> @errorMessage
            <br/><br/>
            <button @onclick="LoadQrCode" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">é‡è¯•</button>
        </div>
    }
    else if (!string.IsNullOrEmpty(qrCodeUrl))
    {
        <div style="text-align: center; margin: 20px 0;">
            <h3>è¯·ä½¿ç”¨é’‰é’‰APPæ‰«æäºŒç»´ç ç™»å½•</h3>
            <div id="qrcode" style="display: inline-block; padding: 20px; background: white; border: 2px solid #ddd; border-radius: 8px; margin: 20px 0;">
                <img src="@GetQrCodeImageUrl()" alt="ç™»å½•äºŒç»´ç " 
                     style="width: 256px; height: 256px; display: block; margin: 0 auto; border: 1px solid #ddd; border-radius: 4px;"
                     onerror="this.parentElement.innerHTML='<p style=&quot;color: red; padding: 20px;&quot;>äºŒç»´ç åŠ è½½å¤±è´¥ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰“å¼€ç™»å½•é¡µé¢</p>'" />
            </div>
            <p style="margin-top: 10px; color: #666;">æˆ–è€…</p>
            <button @onclick="@(() => NavigationManager.NavigateTo(qrCodeUrl, true))" 
                    style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
                åœ¨æ–°çª—å£æ‰“å¼€ç™»å½•é¡µé¢
            </button>
            <div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 4px;">
                <p style="margin: 0; font-size: 14px; color: #0066cc;">äºŒç»´ç  URL: <a href="@qrCodeUrl" target="_blank">@qrCodeUrl</a></p>
            </div>
        </div>
    }
    else if (isLoading)
    {
        <div style="text-align: center; margin: 20px 0;">
            <p>æ­£åœ¨åŠ è½½äºŒç»´ç ...</p>
            <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;"></div>
        </div>
    }
    else
    {
        <div style="background: #d1ecf1; color: #0c5460; padding: 15px; margin: 10px 0; border: 1px solid #bee5eb; border-radius: 4px;">
            <strong>æç¤ºï¼š</strong> é¡µé¢å·²åŠ è½½ï¼Œä½†æœªè·å–åˆ°äºŒç»´ç ã€‚è¯·ç‚¹å‡»é‡è¯•æŒ‰é’®ã€‚
            <br/><br/>
            <button @onclick="LoadQrCode" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">é‡è¯•</button>
        </div>
    }
</div>

<style>
    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script>
    // å¼€å‘æ¨¡å¼ç™»å½•å‡½æ•° - é€šè¿‡ JavaScript è°ƒç”¨ APIï¼Œç¡®ä¿åœ¨æ–°çš„ HTTP è¯·æ±‚ä¸­æ‰§è¡Œ
    window.devLogin = async function(baseUrl) {
        try {
            console.log('å¼€å§‹å¼€å‘æ¨¡å¼ç™»å½•...');
            const response = await fetch(baseUrl + 'api/auth/dev-login', {
                method: 'POST',
                credentials: 'include', // é‡è¦ï¼šåŒ…å« cookies
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('å¼€å‘æ¨¡å¼ç™»å½•å“åº”çŠ¶æ€:', response.status);
            
            if (response.ok) {
                const result = await response.json();
                console.log('å¼€å‘æ¨¡å¼ç™»å½•æˆåŠŸ:', result);
                return true;
            } else {
                const errorText = await response.text();
                console.error('å¼€å‘æ¨¡å¼ç™»å½•å¤±è´¥:', response.status, errorText);
                return false;
            }
        } catch (error) {
            console.error('å¼€å‘æ¨¡å¼ç™»å½•å¼‚å¸¸:', error);
            return false;
        }
    };
</script>

@code {
    [Parameter, SupplyParameterFromQuery] public string? error { get; set; }

    private string qrCodeUrl = string.Empty;
    private string errorMessage = string.Empty;
    private string queryError = string.Empty;
    private bool isLoading = true;
    private bool isInitialized = false;
    private bool qrCodeGenerated = false; // è·Ÿè¸ªäºŒç»´ç æ˜¯å¦å·²ç”Ÿæˆ

    private string GetQrCodeImageUrl()
    {
        if (string.IsNullOrEmpty(qrCodeUrl))
        {
            return string.Empty;
        }
        return $"https://api.qrserver.com/v1/create-qr-code/?size=256x256&data={Uri.EscapeDataString(qrCodeUrl)}";
    }

    protected override void OnInitialized()
    {
        queryError = error ?? string.Empty;
        isLoading = false; // å…ˆè®¾ç½®ä¸º falseï¼Œè®©é¡µé¢ç«‹å³æ˜¾ç¤º
        isInitialized = true;
        Logger.LogInformation("Index.razor OnInitialized. queryError={QueryError}", queryError);
        
        // å…ˆæ˜¾ç¤ºé¡µé¢å†…å®¹ï¼Œç„¶åå¼‚æ­¥åŠ è½½æ•°æ®
        _ = LoadDataAsync();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // äºŒç»´ç ç°åœ¨ç›´æ¥åœ¨ Razor æ¨¡æ¿ä¸­æ¸²æŸ“ï¼Œä¸éœ€è¦ JavaScript å¤„ç†
        // ä¿ç•™æ­¤æ–¹æ³•ä»¥ä¾¿å°†æ¥æ‰©å±•
        await Task.CompletedTask;
    }
    
    private async Task LoadDataAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            Logger.LogInformation("Index.razor LoadDataAsync start");
        
        // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œè®©é¡µé¢å…ˆæ¸²æŸ“
            await Task.Delay(200);

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            var statusResponse = await ApiService.GetLoginStatusAsync();
            if (statusResponse?.Success == true && statusResponse.Data?.IsLoggedIn == true)
            {
                Logger.LogInformation("ç”¨æˆ·å·²ç™»å½•ï¼Œè·³è½¬ /users");
                NavigationManager.NavigateTo("/users", true);
                return;
            }

            // åŠ è½½äºŒç»´ç 
            await LoadQrCode();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Index åˆå§‹åŒ–å¤±è´¥");
            errorMessage = $"åˆå§‹åŒ–å¤±è´¥: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            Logger.LogInformation("Index.razor LoadDataAsync complete. isLoading={IsLoading}, qrCodeUrlç©º: {EmptyQr}", isLoading, string.IsNullOrEmpty(qrCodeUrl));
            StateHasChanged();
        }
    }

    private async Task LoadQrCode()
    {
        try
        {
            qrCodeGenerated = false; // é‡ç½®äºŒç»´ç ç”Ÿæˆæ ‡å¿—
            var response = await ApiService.GetQrCodeAsync();
            if (response?.Success == true && response.Data != null)
            {
                qrCodeUrl = response.Data.QrCodeUrl ?? string.Empty;
                Logger.LogInformation("è·å–äºŒç»´ç æˆåŠŸ: {Url}", qrCodeUrl);
                
                // æ›´æ–° UIï¼ŒOnAfterRenderAsync ä¼šè‡ªåŠ¨å¤„ç†äºŒç»´ç ç”Ÿæˆ
                StateHasChanged();
            }
            else
            {
                errorMessage = response?.Message ?? "è·å–äºŒç»´ç å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ";
                Logger.LogWarning("è·å–äºŒç»´ç æ¥å£å¤±è´¥: {Message}", errorMessage);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"è·å–äºŒç»´ç å¤±è´¥: {ex.Message}ã€‚è¯·æ£€æŸ¥ï¼š1) åç«¯ API æ˜¯å¦æ­£å¸¸è¿è¡Œ 2) ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ 3) æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯";
            Logger.LogError(ex, "è·å–äºŒç»´ç å¼‚å¸¸");
        }
        finally
        {
            isLoading = false;
            isInitialized = true;
            Logger.LogInformation("LoadQrCode å®Œæˆ. isLoading={IsLoading}, errorMessageç©º: {EmptyError}", isLoading, string.IsNullOrEmpty(errorMessage));
            StateHasChanged();
        }
    }

    private async Task SkipLogin()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            Logger.LogInformation("å¼€å§‹å¼€å‘æ¨¡å¼ç™»å½• - ä½¿ç”¨ JavaScript è°ƒç”¨ API");
            
            // ä½¿ç”¨ JavaScript è°ƒç”¨ APIï¼Œè¿™æ ·å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ HTTP è¯·æ±‚
            // æ­¤æ—¶ Session æ˜¯å®Œå…¨å¯ç”¨çš„
            var success = await JSRuntime.InvokeAsync<bool>("devLogin", NavigationManager.BaseUri);
            
            if (success)
            {
                Logger.LogInformation("å¼€å‘æ¨¡å¼ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ° /users");
                // ä½¿ç”¨ forceLoad ç¡®ä¿é‡æ–°åŠ è½½é¡µé¢ä»¥è·å–æ–°çš„ Session
                NavigationManager.NavigateTo("/users", forceLoad: true);
            }
            else
            {
                errorMessage = "å¼€å‘æ¨¡å¼ç™»å½•å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯";
                Logger.LogWarning("å¼€å‘æ¨¡å¼ç™»å½•å¤±è´¥");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"å¼€å‘æ¨¡å¼ç™»å½•å¤±è´¥: {ex.Message}";
            Logger.LogError(ex, "å¼€å‘æ¨¡å¼ç™»å½•å¼‚å¸¸");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task GenerateQrCode(string url)
    {
        try
        {
            // ç›´æ¥ä½¿ç”¨åœ¨çº¿äºŒç»´ç  API ç”Ÿæˆï¼Œä¸ä¾èµ–å¤–éƒ¨å‡½æ•°
            var qrImageUrl = $"https://api.qrserver.com/v1/create-qr-code/?size=256x256&data={Uri.EscapeDataString(url)}";
            
            Logger.LogInformation("å¼€å§‹ç”ŸæˆäºŒç»´ç ï¼ŒURL: {Url}, å›¾ç‰‡URL: {ImageUrl}", url, qrImageUrl);
            
            // ä½¿ç”¨ JavaScript æ’å…¥äºŒç»´ç å›¾ç‰‡ï¼Œæ·»åŠ é‡è¯•æœºåˆ¶
            var success = await JSRuntime.InvokeAsync<bool>("eval", $@"
                (function() {{
                    try {{
                        const container = document.getElementById('qrcode');
                        console.log('æŸ¥æ‰¾äºŒç»´ç å®¹å™¨:', container);
                        
                        if (!container) {{
                            console.error('æ‰¾ä¸åˆ° qrcode å®¹å™¨å…ƒç´ ');
                            return false;
                        }}
                        
                        // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
                        container.innerHTML = '';
                        
                        // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                        const img = document.createElement('img');
                        img.src = '{qrImageUrl}';
                        img.alt = 'äºŒç»´ç ';
                        img.style.width = '256px';
                        img.style.height = '256px';
                        img.style.display = 'block';
                        img.style.margin = '0 auto';
                        img.style.border = '1px solid #ddd';
                        img.style.borderRadius = '4px';
                        
                        // æ·»åŠ åŠ è½½æˆåŠŸå¤„ç†
                        img.onload = function() {{
                            console.log('äºŒç»´ç å›¾ç‰‡åŠ è½½æˆåŠŸ');
                        }};
                        
                        // æ·»åŠ åŠ è½½é”™è¯¯å¤„ç†
                        img.onerror = function() {{
                            console.error('äºŒç»´ç å›¾ç‰‡åŠ è½½å¤±è´¥:', img.src);
                            container.innerHTML = '<p style=\\'color: red; padding: 20px;\\'>äºŒç»´ç åŠ è½½å¤±è´¥ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰“å¼€ç™»å½•é¡µé¢</p>';
                        }};
                        
                        container.appendChild(img);
                        console.log('äºŒç»´ç å·²æ’å…¥åˆ°é¡µé¢ï¼Œå›¾ç‰‡URL: ' + '{qrImageUrl}');
                        return true;
                    }} catch (error) {{
                        console.error('ç”ŸæˆäºŒç»´ç æ—¶å‘ç”Ÿé”™è¯¯:', error);
                        return false;
                    }}
                }})();
            ");
            
            if (success)
            {
                Logger.LogInformation("äºŒç»´ç ç”ŸæˆæˆåŠŸ: {Url}", url);
            }
            else
            {
                Logger.LogWarning("äºŒç»´ç ç”Ÿæˆå¯èƒ½å¤±è´¥ï¼Œå®¹å™¨å¯èƒ½ä¸å­˜åœ¨");
                // å¦‚æœå¤±è´¥ï¼Œè§¦å‘é‡æ–°æ¸²æŸ“ï¼Œè®© OnAfterRenderAsync å†æ¬¡å°è¯•
                await Task.Delay(200);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "ç”ŸæˆäºŒç»´ç å¤±è´¥: {Error}", ex.Message);
            // å³ä½¿å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤º URLï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨æ‰“å¼€
            // è§¦å‘é‡æ–°æ¸²æŸ“ï¼Œè®© OnAfterRenderAsync å†æ¬¡å°è¯•
            await Task.Delay(200);
            StateHasChanged();
        }
    }
}
