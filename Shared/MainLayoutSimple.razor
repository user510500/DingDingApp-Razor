@using Radzen
@using Radzen.Blazor
@inherits LayoutComponentBase

<div style="min-height: 100vh; display: flex; flex-direction: column;">
    <header style="background: #f8f9fa; padding: 15px; border-bottom: 1px solid #dee2e6;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">钉钉管理系统</h3>
            @if (isLoggedIn)
            {
                <div>
                    <span style="margin-right: 15px;">欢迎, @userName</span>
                    <button @onclick="OnLogout" style="padding: 5px 15px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">退出</button>
                </div>
            }
        </div>
    </header>
    
    <nav style="background: #f8f9fa; padding: 10px; border-bottom: 1px solid #dee2e6;">
        <a href="/" style="margin-right: 15px; text-decoration: none; color: #007bff;">首页</a>
        @if (isLoggedIn)
        {
            <a href="/users" style="margin-right: 15px; text-decoration: none; color: #007bff;">人员管理</a>
            <a href="/messages" style="margin-right: 15px; text-decoration: none; color: #007bff;">消息管理</a>
        }
    </nav>
    
    <main style="flex: 1; padding: 20px;">
        @Body
    </main>
    
    <footer style="background: #f8f9fa; padding: 15px; text-align: center; border-top: 1px solid #dee2e6; margin-top: auto;">
        <span>© 2024 钉钉管理系统</span>
    </footer>
</div>

@code {
    [Inject] private ApiService apiService { get; set; } = default!;
    [Inject] private NavigationManager navigationManager { get; set; } = default!;
    
    bool isLoggedIn = false;
    string userName = string.Empty;

    protected override void OnInitialized()
    {
        // 立即渲染，不等待任何异步操作
        // 登录状态检查在后台异步进行，但不阻塞渲染
    }
    
    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // 暂时禁用登录状态检查，避免阻塞渲染
            // 登录状态检查在需要时可以通过其他方式触发
        }
        return Task.CompletedTask;
    }

    private async Task CheckLoginStatus()
    {
        try
        {
            var response = await apiService.GetLoginStatusAsync();
            if (response?.Success == true && response.Data != null)
            {
                isLoggedIn = response.Data.IsLoggedIn;
                userName = response.Data.UserName ?? string.Empty;
            }
        }
        catch (Exception ex)
        {
            // 静默失败，不影响页面显示
            isLoggedIn = false;
            Console.WriteLine($"检查登录状态失败: {ex.Message}");
        }
    }

    private async Task OnLogout()
    {
        try
        {
            await apiService.LogoutAsync();
        }
        catch { }
        isLoggedIn = false;
        navigationManager.NavigateTo("/", true);
    }
}

